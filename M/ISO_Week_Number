// =Table.AddColumn(ТАБЛИЦА, "Номер недели (ISO)", each GetISOWeekNumber([ДАТА_СТОЛБЕЦ]))

(dateInput as any) as number =>
let
    // Функция для вычисления даты первого четверга ISO-недели для заданного года
    GetFirstISOWeekStart = (year as number) as date =>
        let
            firstDayOfYear = #date(year, 1, 1),
            offset = {1, 0, -1, -2, -3, 3, 2}{Date.DayOfWeek(firstDayOfYear, Day.Sunday)}
        in
            Date.AddDays(firstDayOfYear, offset),

    // Функция для получения номера ISO-недели (переименована из Date_ISOWeekNum)
    GetISOWeekNumber = (date as date) as number =>
        let
            year = Date.Year(date),
            firstISOWeekStart = GetFirstISOWeekStart(year),
            nextYearFirstISOWeekStart = GetFirstISOWeekStart(year + 1)
        in
            if date >= firstISOWeekStart and date < nextYearFirstISOWeekStart then
                Number.RoundDown(Duration.Days(date - firstISOWeekStart) / 7) + 1
            else if date < firstISOWeekStart then
                GetISOWeekNumber(#date(year - 1, 12, 31))
            else
                1,

    // Преобразование входной даты в тип date
    inputDate = Date.From(dateInput),

    // Год входной даты
    inputYear = Date.Year(inputDate),

    // Дата начала первой ISO-недели текущего года
    firstISOWeekStartCurrentYear = GetFirstISOWeekStart(inputYear),

    // Дата начала первой ISO-недели следующего года
    firstISOWeekStartNextYear = GetFirstISOWeekStart(inputYear + 1),

    // Расчет номера ISO-недели
    isoWeekNumber =
        if inputDate >= firstISOWeekStartCurrentYear and inputDate < firstISOWeekStartNextYear then
            Number.RoundDown(Duration.Days(inputDate - firstISOWeekStartCurrentYear) / 7) + 1
        else if inputDate < firstISOWeekStartCurrentYear then
            GetISOWeekNumber(#date(inputYear - 1, 12, 31))
        else
            1
in
    isoWeekNumber
